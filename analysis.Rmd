```{r, message = FALSE}
library(ggmap)
library(sf)
library(dplyr)
library(auk)
library(lme4)
library(DHARMa)
library(gridExtra)
library(AICcmodavg)
library(rstanarm)
library(broom)
library(xtable)
library(gam)
```

Set the crs used in all analysis as a memorable variable.
Set a boolean varialbe for if the markdown should generate hundreds of species and
family specific maps.
```{r}
crs.m <- 32619
generate.maps <- FALSE
```

Define color pallette
```{r}
pallette <- c("black", "deepskyblue2", "darkseagreen2", "coral3", "snow2")
```


Read in data 
```{r}
#A1
freq.a1 <- readRDS("rds-files\\county_freq_a1.rds")
o.freq.a1 <- readRDS("rds-files\\state_freq_a1.rds")
b.freq.a1 <- readRDS("rds-files\\biased_freq_a1.rds")
freq.a1.km <- readRDS("rds-files\\freq_a1_km.rds")
bba1m <- readRDS("rds-files\\bba1m.rds")
#A2
freq.a2 <- readRDS("rds-files\\county_freq_a2.rds")
o.freq.a2 <- readRDS("rds-files\\state_freq_a2.rds")
b.freq.a2 <- readRDS("rds-files\\biased_freq_a2.rds")
freq.a2.km <- readRDS("rds-files\\freq_a2_km.rds")
bba2m <- readRDS("rds-files\\bba2m.rds")
# this shapefile is not included in the repo, but is not important for any code
shape <- read_sf(dsn = "..\\state_outline", layer = "State_Outline_v5")

# load in atlas 2 block data
blocks <- read_sf(dsn = "newblocksshapefile", layer = "BBA_Blocks_20180216")
blocks <- st_transform(blocks, crs = st_crs(crs.m))

# load in county data 
me.county <- readRDS("rds-files\\county_avgs.rds")
```

Create Map of Weighted vs Unweighted Centroid Differences
```{r}
county_centroid_map <- ggplot() +
  geom_sf(data = me.county, aes(geometry = geometry), color = "black", fill = "white") +
  geom_point(data = me.county, aes(x = lon, y = lat), color = "blue", size = 1) +
  geom_point(data = me.county, aes(x = w.lon, y = w.lat), color = "red", size = 1) +
  labs(title = "Coverage County Centroids")
county_centroid_map
```



Initialize map of Maine with A2 quads
Comment this chunk out if there is no Maine outline shape file.
```{r}
shape <- st_transform(shape, crs = st_crs(bba2m))
maine <- shape %>%
  filter(STATE == 'Maine')

maine_shape <- ggplot(maine) +
  geom_sf(fill = NA, color = "black") +
  theme_minimal()

maine_quads <- ggplot(maine) +
  geom_sf(fill = NA, color = "black") +
  geom_sf(data = bba2m, aes(geometry = geometry), color = "grey", fill = NA) +
  theme_minimal()


maine_quads
```
```{r}
a1.cov.map <- ggplot() +
  geom_sf(data = bba1m, aes(geometry = geometry, fill = coverage)) +
  scale_fill_manual(values = c("black", "snow4", "snow3", "snow")) +
  # labs(title = "Atlas 1 Quad Coverage Status Distribution") +
  theme_minimal()

a1.cov.map
# save to jpg
ggsave(filename = "output_imgs\\a1_cov_map.jpg", plot = a1.cov.map, dpi = 1200)
```


Define the function to plot lat and lon changes by categorization
Then plot bird group, family
```{r}

plot_bias_adj <- function(atlas, X, Y, col, title, x.title, y.title) {
  ggplot(atlas, aes(x = !!sym(X), y = !!sym(Y), color = !!sym(col))) +
    geom_hline(yintercept = 0, color = "black", linewidth = 1) +
    geom_vline(xintercept = 0, color = "black", linewidth = 1) +
    geom_point(size = 1) + # Increase dot size
    labs(
      title = title,
      x = x.title,
      y = y.title,
      color = title
    ) +
    theme_minimal()
}


plot_bias_adj(atlas=bias.compare, X="lon.change", Y="lat.change", 
           col="adjustment", title="Lat / Lon Change from A1 to A2", 
           x.title="Longitudinal Change (m)", y.title="Latitudinal Changes (m)")

plot_bias_adj(atlas=bias.compare, X="coast.change", Y="ele.change", 
           col="adjustment", title="Elevation and Coastal Change  from A1 to A2", 
           x.title="Change in Distance from Coast (m)", y.title="Elevation Changes (m)")
```
Bar chart of species bias adjustment, old adjustment, and no adjustment for each species.
Use comparison=bias.compare to see statewide vs county vs unadjusted.
Use comparison=bias.compare.county tp see just county vs unadjusted.
```{r}
species_bias_adj <- function(bird, comparison) {
  group <- comparison %>% 
    filter(species == bird)
  lat.bar <- ggplot(data = group, aes(x = adjustment, y = lat.change)) +
    # geom_point(size = 1) +
    geom_hline(yintercept = 0, color = "black", linewidth = 1) +
    geom_bar(stat = "identity", fill = "blue") +
    labs(title = bird) +
    theme_minimal()
  lon.bar <- ggplot(data = group, aes(x = adjustment, y = lon.change)) +
    # geom_point(size = 1) +
    geom_hline(yintercept = 0, color = "black", linewidth = 1) +
    geom_bar(stat = "identity", fill = "orange") +
    labs(title = bird) +
    theme_minimal()
  ele.bar <- ggplot(data = group, aes(x = adjustment, y = ele.change)) +
    # geom_point(size = 1) +
    geom_hline(yintercept = 0, color = "black", linewidth = 1) +
    geom_bar(stat = "identity", fill = "red") +
    labs(title = bird) +
    theme_minimal()
  
  coast.bar <- ggplot(data = group, aes(x = adjustment, y = coast.change)) +
    # geom_point(size = 1) +
    geom_hline(yintercept = 0, color = "black", linewidth = 1) +
    geom_bar(stat = "identity", fill = "purple") +
    labs(title = bird) +
    theme_minimal()
  grid.arrange(lat.bar, lon.bar, ele.bar, coast.bar, ncol=2)
}
species_bias_adj("Northern Cardinal", bias.compare)
# species_bias_adj("Tufted Titmouse")
species_bias_adj("Wood Thrush", bias.compare.county)
species_bias_adj("Mourning Warbler", bias.compare.county)
species_bias_adj("Indigo Bunting", bias.compare.county)
species_bias_adj("Pine Warbler", bias.compare.county)
species_bias_adj("Red-winged Blackbird", bias.compare.county)
species_bias_adj("Alder Flycatcher", bias.compare.county)
species_bias_adj("Wood Duck", bias.compare.county)
```


Function: plot frequencies of changes in 4 variables
```{r}
histo <- function(atlas, col, bin, hue, unit, X, Y, name) {
  avg <- mean(atlas[[col]])
  rnd.avg <- round(avg, 1)
  ggplot(atlas, aes(x = !!sym(col))) +
  geom_histogram(binwidth = bin, fill = hue, color = "black", alpha = 0.7,
                 center = bin/2) +
  geom_vline(xintercept=0,
              color = "black", linewidth=1) +
  geom_vline(xintercept=avg, linetype="dashed", # uses unrounded mean for line
            color = "black", linewidth=1) +
  annotate("text", x = X, y = Y, label = "avg") +
  # geom_text(aes(x = x_text, y = 15, label = paste("Mean =", rnd.avg, unit)),
  #           color = "black", size = 5) +
  labs(
    title = name,
    x = unit,
    y = "Number of Species"
  ) +
  theme_minimal()
}


# histo1 <- histo(freq.a2.km, 'coast.change', 5, 'navyblue', 
#                 "Shift in Distance to Coast from 1983 to 2019",
#                 'Distance to Coast Shift (km)', 65)
lat.histo <- histo(freq.a2.km, 'lat.change', 5, 'darkgrey', 'Shift (km)', 15, 22,
                   "Distribution of Latitudinal Shift Across Species")
lon.histo <- histo(freq.a2.km, 'lon.change', 5, 'darkgrey', 'Shift (km)', 4, 43,
                   "Distribution of Longitudinal Shift Across Species")
ele.histo <- histo(freq.a2.km, 'ele.change', 5, 'darkgrey', 'Shift (m)', 25, 18,
                   "Distribution of Elevation Shift Across Species")
ggsave(filename = "output_imgs\\lat_histo.jpg", plot = lat.histo, dpi = 1200, width = 6.5, height = 4, units = "in")
ggsave(filename = "output_imgs\\lon_histo.jpg", plot = lon.histo, dpi = 1200, width = 6.5, height = 4, units = "in")
ggsave(filename = "output_imgs\\ele_histo.jpg", plot = ele.histo, dpi = 1200, width = 6.5, height = 4, units = "in")
```
Compare center shifts to boundary shifts
```{r}
lat.change.sd <- round(sd(freq.a2.km$lat.change), 1)
ele.change.sd <- round(sd(freq.a2.km$ele.change), 1)

paste0("latitude center change sd = ", lat.change.sd)
paste0("elevation average change sd = ", ele.change.sd)
```


Plot boundaries for any species with 40 or more occurrences
```{r}
plot_boundaries <- function(bird) {
  # I use the unmodified (.u) version of the freq dfs so the boundary lines show
  # properly on a map
  boundary1 <- freq.a1 %>% filter(species == bird)
  boundary2 <- freq.a2 %>% filter(species == bird)
  # print(boundary1)
  # print(boundary2)
  maine_quads +
    geom_hline(data = boundary1, aes(yintercept = s.lat, color = "S Boundary A1"),
               show.legend = TRUE) +
    geom_hline(data = boundary1, aes(yintercept = n.lat, color = "N Boundary A1"),
               show.legend = TRUE) +
    geom_hline(data = boundary2, aes(yintercept = s.lat, color = "S Boundary A2"),
               show.legend = TRUE) +
    geom_hline(data = boundary2, aes(yintercept = n.lat, color = "N Boundary A2"),
               show.legend = TRUE) +
    scale_color_manual(
      name = "Boundary Lines",
      values = c(
        "S Boundary A1" = "red",
        "N Boundary A1" = "red",
        "S Boundary A2" = "blue",
        "N Boundary A2" = "blue"
      )
    ) +
    labs(
      title = paste0(bird, " Latitudinal Boundaries"),
      # title = paste0(bird, " Latitudinal Boundaries"),
      x = "Longitude",
      y = "Latitude"
    ) +
    theme_minimal()
}

if (generate.maps) {
  for (i in freq.a1$species) {
    map <- plot_boundaries(i)
    # p.shift <- paste0("Distribution Center Shift for ", i)
    file.shift <- paste0(i, '.jpg')
    ggsave(filename = file.shift, path = '..\\boundary_shift_plots', plot = map,
           dpi = 1200)
  
  }
}

# map <- plot_boundaries(freq.a1$species[1])
# map
# lapply(freq.a1$species, plot_boundaries)
```



Intialize center_limit function
```{r}
center_limit <- function(one_bird, bird, min, max, mid, plot_name, y_axis, da)
{

  common_columns <- intersect(names(freq.a1.km), names(freq.a2))

  sym.mid <- ensym(mid)
  sym.min <- ensym(min)
  sym.max <- ensym(max)

  one.bird.a2 <- freq.a2.km[, common_columns]

  one.bird.a1 <- freq.a1.km[, common_columns] 
  if (one_bird){
    one.bird.a2 <- one.bird.a2 %>% 
      filter(species == bird)
    one.bird.a1 <- one.bird.a1 %>% 
      filter(species == bird)
  }

  one.bird.a1$atlas <- "A1"
  one.bird.a1
  one.bird.a2$atlas <- "A2"
  one.bird.a2
  one.bird <- rbind(one.bird.a1, one.bird.a2)

  p <- ggplot(one.bird, aes(x = atlas, y = !!sym(mid), color = bird.group)) + 
      geom_point(position = position_dodge(width = 0.5)) +
      labs(x = "Atlas", y = y_axis, title = plot_name) +
      theme_minimal()

  
  if (one_bird) {
    p <- p + geom_errorbar(aes(ymin = !!sym(min), ymax = !!sym(max)), width = 0.2,
                           position = position_dodge(width = 0.2)) +
      theme(legend.position = "none")
  }

  return(p)
  print("complete H")
}

# center_limit(TRUE, "Northern Cardinal", 's.lat', 'n.lat', 'lat', "Center & Limit of Latitude for Northern Cardinal NO BIAS ADJUSTMENT", 'Latitude (m)', da.lat)
```


Create a center and limit plot for each species
```{r}
if (generate.maps) {
  for (i in 1:nrow(freq.a1.km)) {
    row1 <- freq.a1.km[i, ]
    row2 <- freq.a2.km[i, ]
    b <- unlist(row1$species)
   
    t.lat <- paste0("Center & Limit of Latitude for ", b)
    t.lon <- paste0("Center & Limit of Longitude for ", b)
    t.ele <- paste0("Center & Limit of Elevation for ", b)
    t.c <- paste0("Center & Limit of Distance to Coast for ", b)
    
    p.lat <- center_limit(TRUE, b, 's.lat', 'n.lat', 'lat', t.lat, 'Latitude (km)', 
                          da = da.lat)
    p.lon <- center_limit(TRUE, b, 'w.lon', 'e.lon', 'lon', t.lon, 'Longitude (km)',
                          da.lat)
    p.ele <- center_limit(TRUE, b, 'min.ele', 'max.ele', 'avg.ele', t.ele, 
                          'Elevation (m)', da.ele)
    p.c <- center_limit(TRUE, b, 'min.coast', 'max.coast', 'd.to.coast', t.c,
                 'Distance to Coast (km)', da.coast)
   
    file.lat <- paste0(t.lat, '.jpg')
    file.lon <- paste0(t.lon, '.jpg')
    file.ele <- paste0(t.ele, '.jpg')
    file.c <- paste0(t.c, '.jpg')
  
    ggsave(filename = file.lat, path = '..\\center_lim_plots', plot = p.lat,
           dpi = 1200)
    ggsave(filename = file.lon, path = '..\\center_lim_plots', plot = p.lon,
           dpi = 1200)
    ggsave(filename = file.ele, path = '..\\center_lim_plots', plot = p.ele,
           dpi = 1200)
    ggsave(filename = file.c, path = '..\\center_lim_plots', plot = p.c,
           dpi = 1200)
  
  }
}

```

Split Parulidae family
THIS CODE BREAKS IF RUN MORE THAN ONCE IN A ROUND
```{r}
# init a df of only species in Parulidae family
parulidae_indices <- which(freq.a2$Family == "Parulidae")
parulidae_indices
# find the length of the df and split it into 3 roughly even segments
n <- length(parulidae_indices)
n
split_points <- c(8, 16)
# initialize new dfs for a1 and a2
freq.a1.par <- freq.a1
freq.a2.par <- freq.a2
# split the parulidae family in the new dfs
freq.a1$Family[parulidae_indices[1:split_points[1]]] <- "Parulidae 1/3"
freq.a1$Family[parulidae_indices[(split_points[1] + 1):split_points[2]]] <- "Parulidae 2/3"
freq.a1$Family[parulidae_indices[(split_points[2] + 1):n]] <- "Parulidae 3/3"

freq.a2$Family[parulidae_indices[1:split_points[1]]] <- "Parulidae 1/3"
freq.a2$Family[parulidae_indices[(split_points[1] + 1):split_points[2]]] <- "Parulidae 2/3"
freq.a2$Family[parulidae_indices[(split_points[2] + 1):n]] <- "Parulidae 3/3"
```

Initialize shift.sf data.frame to plot shift arrows on a map
```{r}
# center_shift_data <- function(a1, a2) {
# A1 has no bias factor to account for
start_coords <- st_coordinates(freq.a1.km$geometry) 
end_coords <- st_coordinates(freq.a2.km$geometry) 

# initialize linestrings
shift_lines <- lapply(1:nrow(start_coords), function(i) {
  st_linestring(matrix(c(start_coords[i, ], end_coords[i, ]), ncol = 2, byrow = TRUE))
})
# convert linestrings to sf
shift.sf <- st_sf(geometry = st_sfc(shift_lines), crs = st_crs(freq.a1.km))
shift.sf <- st_sf(species = freq.a1.km$species, family = freq.a1.km$Family,
                  bird.group = freq.a1.km$bird.group, 
                  geometry = st_sfc(shift_lines), crs = st_crs(freq.a1.km))


coords <- lapply(shift.sf$geometry, function(x) st_coordinates(x))


lat.diff <- sapply(coords, function(coord) coord[2, 2] - coord[1, 2])

shift.sf$lat.shift <- lat.diff > 0
shift <- shift.sf %>% 
  mutate(lat.shift = ifelse(lat.shift, "North", "South"))
# return(shift)
# }
# shift.sf <- center_shift_data()
# saveRDS(object = shift.sf, file = "rds-files\\arrow_map_data.rds")
```


Map center of distribution changes with arrows
```{r}
# to change it back to original plots, set color to lat.shift, filter by group,
# and change legend title

families <- unique(freq.a2$Family)

# define function for creating arrow maps
arrow_map <- function(fam) {
  shift.group <- shift.sf %>%
    filter(family == fam)

  arrows <- maine_quads +
    geom_sf(data = shift.group, aes(geometry = geometry, color = species), arrow =
            arrow(length = unit(0.2, "cm"))) +
    # scale_color_manual(name = "Latitudinal Direction of Shift") +
    theme_minimal() +
    labs(title = paste0("Center of Distribution Shift from A1 to A2 for ", fam),
         color = "Species")
  return(arrows)
}


# apply to each family of bird species and save as a jpeg
if (generate.maps) {
  for (i in families) {
    map <- arrow_map(i)
    # p.shift <- paste0("Distribution Center Shift for ", i)
    file.shift <- paste0(i, '.jpg')
    ggsave(filename = file.shift, path = '..\\center_shift_plots', plot = map,
           dpi = 1200)
  
  }
}
# shift.maps <- lapply(families, arrow_map)
# shift.maps
```

Map a single bird's center of distribution change across all bias adjustment methods
```{r}
singel_bird_arrow_map <- function(bird) {
  shift.group <- shift.sf %>%
    filter(species == bird)

  arrows <- maine_quads +
    geom_sf(data = shift.group, aes(geometry = geometry, color = species), arrow =
            arrow(length = unit(0.2, "cm"))) +
    # scale_color_manual(name = "Latitudinal Direction of Shift") +
    theme_minimal() +
    labs(title = paste0("Center of Distribution Shift from A1 to A2 for ", species),
         color = "Species")
  return(arrows)
}
```


Map center of distribution changes with arrows
```{r}
# to change it back to original plots, set color to lat.shift, filter by group,
# and change legend title

groups <- unique(freq.a2$bird.group)


arrow_map_group <- function(g) {
  shift.group <- shift.sf %>% 
    filter(bird.group == g)
  
  arrows <- maine_quads +
    geom_sf(data = shift.group, aes(geometry = geometry, color = lat.shift), arrow =
            arrow(length = unit(0.2, "cm"))) +
    # scale_color_manual(name = "Latitudinal Direction of Shift") +
    theme_minimal() +
    labs(title = paste0("Center of Distribution Shift from A1 to A2 for ", g),
         color = "Latitudinal Direction of Shift")
  return(arrows)
}

shift.maps <- lapply(groups, arrow_map_group)
shift.maps
```

Create Color Scale Map for Elevation and Coastal Change
```{r}
c_scale_categories <- function(var, key, title) {
  var_sym <- ensym(var)  # Convert the input to a symbol
  print(var)
  # Create a new categorical variable based on the specified ranges
  freq.a2.km <- freq.a2.km %>%
    mutate(value_category = case_when(
      !!var_sym >= -200 & !!var_sym < -100 ~ "-200:-100",
      !!var_sym >= -100 & !!var_sym < -50 ~ "-100:-50",
      !!var_sym >= -50 & !!var_sym < 0 ~ "-50:0",
      !!var_sym >= 0 & !!var_sym < 50 ~ "0:50",
      !!var_sym >= 50 & !!var_sym < 100 ~ "50:100",
      !!var_sym  >= 100 & !!var_sym < 200 ~ "100:200"
    ))

  # freq.a2.km <- freq.a2.km %>%
  #    mutate(value_category = ifelse(var >= -200 & var < -100, "-200:-100", 
  #                                   "out of range"))
  # freq.a2.km <- freq.a2.km %>%
  #   mutate(value_category = ifelse(var >= -100 & var < 0, "-100:0", 
  #                                   value_category))
  # freq.a2.km <- freq.a2.km %>%
  #   mutate(value_category = ifelse(var >= 0 & var < 100, "0:100", 
  #                                   value_category))
  # freq.a2.km <- freq.a2.km %>%
  #   mutate(value_category = ifelse(var >= 100 & var < 200, "100:200", 
  #                                   value_category)) 
  
  maine_quads +
    geom_sf(data = freq.a2.km, 
            aes(geometry = geometry, color = value_category)) +
    scale_color_manual(name = key, 
                       values = c(
                         "-200:-100" = "darkblue",
                         "-100:-50" = "blue",
                         "-50:0" = "lightblue",
                         "0:50" = "pink",
                         "50:100" = "red",
                         "100:200" = "darkred"
                       )) +
    theme_minimal() +
    labs(title = title)
}

c_scale_categories("coast.change", "Distance to Coast Change (km)", 
                   "Current Center of Distribution & Change in Distance to Coast")
c_scale_categories("ele.change", "Elevation Change (m)",
                   "Current Center of Distribution & Change in Elevation")

```



Create a species count for each block
```{r}
# create atlas 1 species list to iterate through
start_col <- which(names(bba1m) == "American Black Duck")
end_col <- which(names(bba1m) == "Yellow-throated Vireo")
species.a1 <- colnames(bba1m)[start_col:end_col]
# create atlas 1 species list to iterate through
start_col <- which(names(bba2m) == "Acadian Flycatcher")
end_col <- which(names(bba2m) == "Yellow Warbler")
species.a2 <- colnames(bba2m)[start_col:end_col]

bba1m.species <- subset(bba1m, select = species.a1)
bba2m.species <- subset(bba2m, select = species.a2)


# this function returns the count of non NA values in a row
sum_binary <-  function(row) {
  row <- as.list(row)

  # Remove the last element (which is the sf_point)
  row <- row[-length(row)]
  new_row <- sapply(row, function(x) ifelse(is.na(x) | x == 0, 0, 1))
  # this statement had to be separate in order to ensure all values were numeric
  # new_row <- sapply(row, function(x) ifelse(x == 2 | x == 0, 0, 1))
  # print(new_row)
  row_count <- sum(new_row)
  return(row_count)
}
count.a1 <- vector()
count.a2 <- vector()
for (i in 1:nrow(bba1m.species)) {
  # atlas 1
  current_row.a1 <- bba1m.species[i, ]
  count.a1 <- c(count.a1, sum_binary(current_row.a1))
  # atlas 2
  current_row.a2 <- bba2m.species[i, ]
  count.a2 <- c(count.a2, sum_binary(current_row.a2))
}

bba1m.species <- bba1m.species %>%
  mutate(species_count = count.a1)
bba2m.species <- bba2m.species %>%
  mutate(species_count = count.a2)

# A1 is subtracted from A2 to show an increase overtime as positive
bba2m.species <- bba2m.species %>%
  mutate(count_diff = species_count - bba1m.species$species_count)

bba2m.species <- bba2m.species %>%
  mutate(diff_rank = ifelse(count_diff > 0, 'increase', 'same'))

bba2m.species <- bba2m.species %>%
  mutate(diff_rank = ifelse(count_diff < 0, 'decrease', diff_rank))
max(bba2m.species$species_count)
```

Plot species count for each atlas and the difference
```{r}
ggplot() +
  geom_sf(data = bba1m.species, aes(geometry = geometry, fill = species_count),
          color = "black") +
  labs(title = "Atlas 1 Species Count by Quad") +
  theme_minimal()

ggplot() +
  geom_sf(data = bba2m.species, aes(geometry = geometry, fill = species_count),
          color = "black") +
  labs(title = "Atlas 2 Species Count by Quad") +
  theme_minimal()

ggplot() +
  geom_sf(data = bba2m.species, aes(geometry = geometry, fill = count_diff),
          color = "black") +
  labs(title = "Atlas 2 Count - Atlas 1 Count") +
  theme_minimal()

ggplot() +
  geom_sf(data = bba2m.species, aes(geometry = geometry, fill = diff_rank),
          color = "black") +
  labs(title = "Species Richness Change from A1 to A2") +
  theme_minimal()
```

```{r}

# block.covs <- st_as_sf(block.covs)
# bba1m <- st_as_sf(bba1m)

# block.covs.a1 <- st_join(block.covs, bba1m, join = st_equals)

block.covs.a1 <- join_by(bba1m, block.covs)
```

Create a table with geographic variable changes
```{r}
geo.shifts <- subset(freq.a2.km, select=c("species", "Family", "lat.change",
                                           "lon.change", "ele.change", 
                                           "coast.change"))
geo.shifts <- sf::st_drop_geometry(geo.shifts)
geo.shifts
```


Simplify Change Dataset
```{r}
drop.cols.delta <- c("s.lat", "n.lat", "num.blocks", "avg.ele", "med.ele", "w.lon",
               "e.lon", "min.ele", "max.ele", "min.coast", "max.coast", "lon",
               "lat", "d.to.coast", "s.lat.change", "n.lat.change", "max.ele.change")
delta <- freq.a2.km %>%
  # use trigonometry to add angle and actual distance of shift
  mutate(angle = atan2(lat.change, lon.change)) %>% # angle in radians
  mutate(c = sqrt(lat.change^2 + lon.change^2)) %>% 
  # simplify data that already exists in freq.a2.km
  select(-drop.cols.delta) %>% 
  rename(lat = lat.change, lon = lon.change, ele = ele.change, family = Family)
# create the endpoints for a trigonometry graph
delta <- delta %>% 
  mutate(x.end = c * cos(angle)) %>% 
  mutate(y.end = c * sin(angle))
names(delta)
```
Create Radar Graph
```{r}
delta.cards <-  delta[delta$family == "Cardinalidae", ]
ggplot(delta) +
 geom_segment(aes(x = 0, y = 0, xend = x.end, yend = y.end, color = bird.group), 
               arrow = arrow(length = unit(0.1, "inches"))) +
  # scale_color_viridis_c() +
  coord_fixed() +
  labs(title = "Real Distances (km) and Angles")
       # x = "X Coordinate", 
       # y = "Y Coordinate") +
  theme_minimal()

```
```{r}
ggplot(delta) +
  geom_point(aes(x = x.end, y = y.end, color = bird.group), 
             size = 1) +  # Adjust point size
  # scale_color_viridis_c() +  # Color scale based on density
  geom_hline(yintercept = 0, color = "black", linewidth = 1) +
  geom_vline(xintercept = 0, color = "black", linewidth = 1) +
  coord_fixed() +
  labs(title = "All Species Shifts")
       # x = "X Coordinate", 
       # y = "Y Coordinate") +
  theme_minimal()
```


Add change by family dataset
```{r}
delta.fam <- delta %>% 
  group_by(family) %>% 
  reframe(
    lat = mean(lat),
    lon = mean(lon),
    ele = mean(ele)
  )
delta.fam
```
Create and save summary data.frame
```{r}
delta.summary <- delta %>%
  st_drop_geometry() %>% 
  reframe(
    mean_species = c(mean(lat), mean(lon), mean(ele)),
    sd_species = c(sd(lat), sd(lon), sd(ele)),
    mean_family = c(mean(delta.fam$lat), mean(delta.fam$lon), mean(delta.fam$ele)),
    sd_family = c(sd(delta.fam$lat), sd(delta.fam$lon), sd(delta.fam$ele))
  )
delta.summary$variable <-  c('Latitude', 'Longitude', 'Elevation')
# print in latex readable format
print(xtable(delta.summary, type = "latex"))
```



Add Traits Data
```{r}
# line up freq.a2.km and traits dataset
traits1 <- read.csv("other_csvs\\avonet1_traits.csv")
traits2 <- read.csv("other_csvs\\avonet2_traits.csv")
traits3 <- read.csv("other_csvs\\avonet3_traits.csv")

colnames(traits1)[colnames(traits1) == "Species1"] <- "sci_name"
colnames(traits2)[colnames(traits2) == "Species2"] <- "sci_name"
colnames(traits3)[colnames(traits3) == "Species3"] <- "sci_name"

int.species1 <- intersect(unlist(delta$sci_name), unlist(traits1$sci_name))
int.species2 <- intersect(unlist(delta$sci_name), unlist(traits2$sci_name))
int.species3 <- intersect(unlist(delta$sci_name), unlist(traits3$sci_name))

relevant.traits <- c("sci_name", "Wing.Length", "Tail.Length", "Mass",
                     "Trophic.Level", "Trophic.Niche", "Primary.Lifestyle")

traits1 <- traits1 %>% 
  filter(sci_name %in% int.species1) %>% 
  select(relevant.traits)
traits2 <- traits2 %>% 
  filter(sci_name %in% int.species2) %>% 
  select(relevant.traits) 

traits3 <- traits3 %>% 
  filter(sci_name %in% int.species3) %>% 
  select(relevant.traits) 
  # filter(!sci_name %in% int.species.2) %>% 
  # filter(!sci_name %in% int.species.1)

traits <- distinct(rbind(traits1, traits2, traits3))
traits <- traits %>% 
  group_by(sci_name) %>% 
  reframe(
    wing.length = mean(Wing.Length),
    tail.length = mean(Tail.Length),
    mass = mean(Mass),
    trophic.level = Trophic.Level,
    trophic.niche = Trophic.Niche,
    primary.lifestyle = Primary.Lifestyle
  )
traits <- distinct(traits)
dim(traits)
int.species <- intersect(unlist(delta$sci_name), unlist(traits$sci_name))
# drop 2 warblers from the dataset
delta.traits <- delta %>% 
  filter(sci_name %in% int.species)
# add actual trait data
delta.traits <- left_join(delta.traits, traits, by = 'sci_name') %>% 
  # scale explanatory variables
  mutate(
    lat = scale(lat),
    lon = scale(lon),
    ele = scale (ele)
  )

```
traits test
```{r}
avo.species <- c(traits1$sci_name, traits2$sci_name, traits3$sci_name)
avo.species
```


Find important raw metrics
```{r}
max.shifts <- delta %>%
  filter(ele > 100)
max.shifts <- subset(max.shifts,
                     select=c('species', "family",
                              'ele'))
max.shifts
```


load out traits data
```{r}
write.csv(delta, "change_dataset.csv")
write.csv(delta.traits, "change_dataset_with_traits.csv")
```


# ANALYSIS ONGOING WORK

Initialize models
```{r}
# basic linear
lat.int <- lm(lat ~ 1, data = delta)
lon.int <- lm(lon ~ 1, data = delta)
ele.int <- lm(ele ~ 1, data = delta)

# random effects of family
ele.fam <- stan_glmer(ele ~ (1|family), data = delta.fam)
lat.fam <- stan_glmer(lat ~ (1|family), data = delta.fam)
lon.fam <- stan_glmer(lon ~ (1|family), data = delta.fam)
# traits
# morphology
ele.morph <- lm(ele ~ mass, data = delta.traits)
lat.morph <- lm(lat ~ mass, data = delta.traits)
lon.morph <- lm(lon ~ mass, data = delta.traits)

# foraging
ele.forage <- lm(ele ~ trophic.niche, data = delta.traits)
lat.forage <- lm(lat ~ trophic.niche, data = delta.traits)
lon.forage <- lm(lon ~ trophic.niche, data = delta.traits)

# habitat
ele.habitat <- lm(ele ~ Breeding.Biome, data = delta.traits)
lat.habitat <- lm(lat ~ Breeding.Biome, data = delta.traits)
lon.habitat <- lm(lon ~ Breeding.Biome, data = delta.traits)

gam.ele.habitat <- gam(ele ~ Breeding.Biome, data = delta.traits)
gam.lat.habitat <- gam(lat ~ Breeding.Biome, data = delta.traits)
gam.lon.habitat <- gam(lon ~ Breeding.Biome, data = delta.traits)
gam.ele.habitat

ele.traits <- list("elevation by morphology" = ele.morph, 
                   "elevation by foraging niche" = ele.forage,
                   "elevation by habitat" = ele.habitat)
lat.traits <- list("latitude by morphology" = lat.morph, 
                   "latitude by foragin niche" = lat.forage,
                   "latitude by habitat" = lat.habitat)
lon.traits <- list("longitude by morphology" = lon.morph, 
                   "longitude by foraging niche" = lon.forage,
                   "longitude by habitat" = lon.habitat)
```

Mixed Effects Summary
```{r}
# family summary data.frame

# the order for the rows is lat, lon, ele as fam.model.names shows
lat.posterior <- data.frame(posterior_interval(lat.fam, prob = 0.95))
lon.posterior <- data.frame(posterior_interval(lon.fam, prob = 0.95))
ele.posterior <- data.frame(posterior_interval(ele.fam, prob = 0.95))
mixed.summary <- data.frame(
  variable = c("Latitude", "Longitude", "Elevation"),
  family_sd = c(12, 5.7, 15),
  residual_sd = c(16, 6.9, 21),
  mean_r_squared = c(mean(bayes_R2(lat.fam)), mean(bayes_R2(lon.fam)),
                     mean(bayes_R2(ele.fam)))
)
print(xtable(mixed.summary, type="latex"))

intercept_025 <- c(lat.posterior$X2.5.[1], lon.posterior$X2.5.[1], ele.posterior$X2.5.[1])
intercept_975 <- c(lat.posterior$X97.5.[1], lon.posterior$X97.5.[1], ele.posterior$X97.5.[1])

sigma_025 <- c(lat.posterior$X2.5.[43], lon.posterior$X2.5.[43], ele.posterior$X2.5.[43])
sigma_975 <- c(lat.posterior$X97.5.[43], lon.posterior$X97.5.[43], ele.posterior$X97.5.[43])

mixed.intervals <- data.frame(intercept_025, intercept_975, sigma_025, sigma_975)


print(xtable(mixed.intervals, type="latex"))
```


Initialize two sequential functions to create an AIC table from a list of models
```{r}
# the first function extracts basic metrics from an lm() model
aic_table_1 <- function(model, model.name) {
  #number of parameters
  num.params <- length(coef(model))
  # log likelihood
  log.likelihood <- logLik(model)[1]  # Log-likelihood
  # R-squared
  r.squared <- summary(model)$r.squared
  # AIC
  aic <- AIC(model)
  
  aic.table <- data.frame(
    model = model.name,
    parameters = num.params,
    log_likelihood = log.likelihood,
    r_squared = r.squared,
    aic = aic
  )
  return(aic.table)
}
# the second function applies the first to a list, and then adds additional metrics
aic_table_2 <- function(model.list) {
  aic.table <- do.call(rbind, lapply(names(model.list), function(name) {
    aic_table_1(model.list[[name]], name)
  }))
  
  # delta aic and model weight
  aic.table <- aic.table %>%
    mutate(
      delta_aic = aic - min(aic),  # AIC difference from best model
      weight = exp(-0.5 * delta_aic) / sum(exp(-0.5 * delta_aic))  # Akaike weight
    )
  aic.table <- aic.table %>% 
    relocate(aic, .after = model)
  print(xtable(aic.table, type = "latex"))
}

aic_table_2(lat.traits)
aic_table_2(lon.traits)
aic_table_2(ele.traits)
```


Extract fixed effects table from trait tables of interest
```{r}
fixed_effect_table <- function(model, var){
  # create a data.frame of useful statistics for the fixed effect model
  # tested using confint: conf.low = 2.5% and conf.high = 97.5%
  fixed.table <- broom::tidy(model, conf.int = TRUE)
  counts <- model$model %>% 
    count(Breeding.Biome)
  fixed.table <- fixed.table %>% 
    select(term, estimate, std.error, conf.low, conf.high, p.value)
  fixed.table$n <- counts$n
  # make the habitat names readable
  fixed.table$term <- sort(unique(delta$Breeding.Biome))
  fixed.table$term[[1]] <- "Boreal Forest (Intercept)"
  file.name <- paste0("output_csv_files\\", var, "summary.csv")
  write.csv(fixed.table, file.name)
  print(var)
  print(xtable(fixed.table, type = "latex"))
}
fixed_effect_table(lat.habitat, "Latitude")
fixed_effect_table(lon.habitat, "Longitude")
fixed_effect_table(ele.habitat, "Elevation")

```

Take a look at categorical variable counts
```{r}
biome <- delta$Breeding.Biome
biome <- data.frame(biome) %>%
  arrange(biome)
biome <- biome %>% 
  count(biome)
biome

trophic <- delta.traits$trophic.niche
trophic <- data.frame(trophic) %>%
  arrange(trophic)
trophic <- trophic %>% 
  count(trophic)
trophic
```





